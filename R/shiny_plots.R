#
# Shiny wrappers around plotting functions
#

#' @export
shiny_stability <- function(y, x=NULL, design=NULL, bins=20, prefix="") {
    p <- function(name) paste0(prefix,name)

    y <- ensure_reactable(y)
    x <- ensure_reactable(x)
    design <- ensure_reactable(design)
    bins <- ensure_reactable(bins)

    plot <- shiny_plot(
        function(env) {
            bins <- env$input[[p("bins")]]
            stopifnot(bins >= 1)
            print(plot_stability(
                y=y(env),
                x=x(env),
                design=design(env),
                bins=bins
            ))
        },
        dlname="stability_plot",
        prefix=p("plot_")
    )

    ui <- shiny::tags$div(
        shiny::h3("Stability plot"),
        shiny::numericInput(p("bins"), "Bins", value=20,min=1,max=10000),
        plot$component_ui,
        shiny::p(
            "This is a diagnostic plot for the variance stabilizing transformation. ",
            "It shows the amount of noise in the transformed data ",
            "across different expression levels. ",
            "If the transformation has been successful, ",
            "this should be close to a flat line."
            ),
        parenthetically("This plot is produced by varistran::plot_stability.")
    )

    server <- function(env) {
        plot$component_server(env)
    }

    composable_shiny_app(ui, server)
}


#' Shiny wrapper for limma's MDS plot
#'
#' @export
shiny_mds_plot <- function(x, sample_labels=NULL, prefix="") {
    p <- function(name) paste0(prefix,name)

    x <- ensure_reactable(x)
    sample_labels <- ensure_reactable(sample_labels)
    
    plot <- shiny_plot(
        function(env) {
            x_val <- x(env)
            sample_labels_val <- sample_labels(env)
            
            if (!is.null(sample_labels_val))
                colnames(x_val) <- sample_labels_val
        
            limma::plotMDS(x_val, env$input[[p("genes")]])
        },
        prefix = paste0(prefix,"plot_")
    )
    
    ui <- shiny::div(
        shiny::h3("limma MDS plot"),
        shiny::numericInput(p("genes"), "Use this many top genes", value=500, min=1,max=20000),
        plot$component_ui,
        parenthetically("This plot is produced by limma::plotMDS. Gene selection is \"pairwise\".")
    )
    
    server <- function(env) {
        plot$component_server(env)
    }
    
    composable_shiny_app(ui, server)
}


#' @export
shiny_biplot <- function(x, sample_labels=NULL, feature_labels=NULL, n_features=20, balance=0.25, text_size=0.025, prefix="") {
    p <- function(name) paste0(prefix,name)

    x <- ensure_reactable(x)
    sample_labels <- ensure_reactable(sample_labels)
    feature_labels <- ensure_reactable(feature_labels)

    plot <- shiny_plot(
        function(env) {
            print(plot_biplot(
                x = x(env),
                sample_labels = sample_labels(env),
                feature_labels = feature_labels(env),
                n_features = env$input[[p("n_features")]],
                balance = env$input[[p("balance")]],
                text_size = 0.025
            ))
        },
        dlname="biplot",
        prefix=p("plot_")
    )

    ui <- shiny::tags$div(
        shiny::h3("Biplot"),
        shiny::numericInput(p("n_features"), "Number of labelled features", 20, min=0, step=1),
        shiny::numericInput(p("balance"), "Feature/sample relative scaling", 0.25, min=0,step=0.05),
        plot$component_ui,
        parenthetically("This plot is produced by varistran::plot_biplot.")
    )

    server <- function(env) {
        plot$component_server(env)
    }

    composable_shiny_app(ui, server)
}

#' @export
shiny_heatmap <- function(y, sample_labels=NULL, feature_labels=NULL, prefix="") {
    p <- function(name) paste0(prefix,name)

    y <- ensure_reactable(y)
    sample_labels <- ensure_reactable(sample_labels)
    feature_labels <- ensure_reactable(feature_labels)

    plot <- shiny_plot(
        callback = function(env) {
            print(env[[p("grob")]]())
        },
        width=700,
        height=700,
        dlname="heatmap",
        prefix=p("plot_")
    )

    ui <- shiny::tags$div(
        shiny::h3("Heatmap"),
        shiny::p("Features are selected based on span of expression levels."),
        shiny::numericInput(p("n"), "Number of features to show", 50, min=10,max=2000,step=10),
        shiny::checkboxInput(p("cluster_samples"), "Cluster samples", FALSE),
        plot$component_ui,
        parenthetically("This plot is produced by varistran::plot_heatmap.")
    )

    server <- function(env) {
        env[[p("grob")]] <- shiny::reactive(shiny::withProgress(message="Plotting", {
            n <- env$input[[p("n")]]
            if (n > 2000) stop("Drawing large heatmaps uses excessive system resources. Sorry.")

            y_val <- as.matrix(y(env))
            y_span <- apply(y_val,1,max) - apply(y_val,1,min)
            selection <- rep(FALSE,nrow(y_val))
            selection[ order(-y_span)[ seq_len(n) ] ] <- TRUE

            if (sum(selection) < 1) stop("No features to show.")

            plot_heatmap(
                y=y_val[selection,,drop=FALSE],
                sample_labels=sample_labels(env),
                feature_labels=feature_labels(env)[selection],
                cluster_samples=env$input[[p("cluster_samples")]]
            )
        }))

        plot$component_server(env)
    }

    composable_shiny_app(ui, server)
}
